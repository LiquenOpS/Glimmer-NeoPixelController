name: Tests

on:
  push:
    branches: [ master, main, 'refactor/**', 'ci/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.7', '3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies (simulator mode only, no rpi-ws281x)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests
        # Note: rpi-ws281x is not installed as it requires Raspberry Pi hardware
    
    - name: Setup config file
      run: |
        if [ ! -f config/config.json ]; then
          cp config/config.json.example config/config.json
        fi
    
    - name: Test simulator mode (basic startup)
      run: |
        timeout 10 python3 main.py --simulator --no-api || true
        echo "✅ Simulator mode test completed"
    
    - name: Test API with simulator mode
      continue-on-error: true
      run: |
        echo "Starting server in simulator mode..."
        python3 main.py --simulator &
        SERVER_PID=$!
        
        # Wait for server to start
        echo "Waiting for server to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:1129/api/status > /dev/null 2>&1; then
            echo "✅ Server is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "❌ Server failed to start"
            kill $SERVER_PID || true
            exit 1
          fi
          sleep 1
        done
        
        echo "Running API tests..."
        python3 tests/test_api.py || true
        
        echo "Stopping server..."
        kill $SERVER_PID || true
        wait $SERVER_PID || true
