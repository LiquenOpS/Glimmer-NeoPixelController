name: Tests

on:
  push:
    branches: [ master, main, 'refactor/**', 'ci/**' ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies (simulator mode only, no rpi-ws281x)
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests
        # Note: rpi-ws281x is not installed as it requires Raspberry Pi hardware
    
    - name: Setup config file
      run: |
        if [ ! -f config/config.json ]; then
          cp config/config.json.example config/config.json
        fi
    
    - name: Test API with simulator mode
      continue-on-error: true
      timeout-minutes: 5
      run: |
        echo "Starting server in simulator mode..."
        python3 main.py --simulator &
        SERVER_PID=$!
        
        # Wait for server to start
        echo "Waiting for server to be ready..."
        for i in {1..20}; do
          if curl -s http://localhost:1129/api/status > /dev/null 2>&1; then
            echo "✅ Server is ready!"
            break
          fi
          if [ $i -eq 20 ]; then
            echo "❌ Server failed to start"
            kill $SERVER_PID || true
            exit 1
          fi
          sleep 1
        done
        
        echo "Running API tests..."
        python3 tests/test_api.py
        if [ $? -eq 0 ]; then
          echo "✅ All API tests passed!"
        else
          echo "⚠️  Some tests failed (but continuing)"
        fi
        
        echo "Stopping server..."
        kill $SERVER_PID || true
        wait $SERVER_PID || true
